<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FD Calculator ‚Äî Before Maturity Planner</title>
    <meta name="description"
        content="Fixed Deposit before-maturity calculator with FD, DD, MIS, RD, ALD tabs and editable interest rate slabs." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

    <!-- ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ -->
    <nav class="app-nav">
        <div class="nav-logo">
            <span class="nav-logo-text">Premature Calculation</span>
            <span class="nav-logo-sub">built by Bhor</span>
        </div>
        <div class="nav-links">
            <button class="nav-btn" onclick="toggleTheme()" id="theme-toggle" title="Toggle Light/Dark Mode">
                <span class="ic" id="theme-icon">üåô</span>Theme
            </button>
            <button class="nav-btn active" onclick="showPage('home',this)" id="nav-home">
                <span class="ic">üè†</span>Home
            </button>
            <button class="nav-btn" onclick="showPage('settings',this)" id="nav-settings">
                <span class="ic">‚öôÔ∏è</span>Rate Settings
            </button>
        </div>
    </nav>

    <div id="toast" class="toast">Saved!</div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    PAGE 1 ‚Äî HOME / BEFORE MATURITY CALC
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page active" id="page-home">
        <div class="home-wrap">
            <!-- scheme tabs -->
            <div class="scheme-tabs">
                <button class="scheme-tab active" onclick="switchTab('FD',this)">FD<span class="tab-sub">Fixed
                        Deposit</span></button>
                <button class="scheme-tab" onclick="switchTab('DD',this)">DD<span class="tab-sub">Dam
                        Duppat</span></button>
                <button class="scheme-tab" onclick="switchTab('MIS',this)">MIS<span class="tab-sub">Monthly
                        Income</span></button>
                <button class="scheme-tab" onclick="switchTab('DC',this)">DC<span class="tab-sub">Daily
                        Collection</span></button>
            </div>

            <!-- main calculator card -->
            <div class="calc-card">
                <div class="section-label" id="tab-label">Fixed Deposit ‚Äî Before Maturity Calculator</div>

                <!-- Senior / Regular Selection Tabs -->
                <div style="margin-bottom:20px">
                    <div class="fg">
                        <label>Account Type</label>
                        <div class="senior-tabs" id="senior-tabs"
                            style="display:flex; gap:8px; background:var(--bg3); padding:6px; border-radius:12px; border:1px solid var(--border);">
                            <button class="senior-tab active" onclick="setSenior(false,this)"
                                style="flex:1; padding:10px; border:none; background:var(--accent); color:#fff; border-radius:8px; font-weight:600; cursor:pointer; transition:all .2s;">Regular</button>
                            <button class="senior-tab" onclick="setSenior(true,this)"
                                style="flex:1; padding:10px; border:none; background:transparent; color:var(--text2); border-radius:8px; font-weight:600; cursor:pointer; transition:all .2s;">Senior
                                Citizen</button>
                        </div>
                    </div>
                </div>

                <!-- inputs -->
                <div class="form-grid" id="input-grid">
                    <div class="fg">
                        <label>Principal Amount (‚Çπ)</label>
                        <input type="number" id="inp-principal" placeholder="e.g. 100000" onfocus="this.select()"
                            oninput="updateMISReceivedAuto();clearResults()" />
                    </div>
                    <div class="fg">
                        <label>Start Date</label>
                        <input type="date" id="inp-start" onchange="updateRateFromSlab();clearResults()" />
                    </div>
                    <div class="fg">
                        <label>Withdrawal / Current Date <span class="hint">Default: Today</span></label>
                        <input type="date" id="inp-withdraw" onchange="updateRateFromSlab();clearResults()" />
                    </div>
                    <div class="fg" id="slab-rate-fg">
                        <label>Premature Slab Rate (%)</label>
                        <input type="number" id="inp-slab-rate" step="0.01" placeholder="e.g. 4.50"
                            onfocus="this.select()" oninput="clearResults()"
                            title="Base rate for the period money was kept" />
                    </div>
                </div>

                <!-- MIS specific: Original Rate & Interest Received -->
                <div class="form-grid two" id="mis-extra" style="display:none; margin-bottom: 20px;">
                    <div class="fg">
                        <label>Opening / Original Rate (%)</label>
                        <input type="number" id="inp-opening-rate" step="0.01" placeholder="e.g. 9.50"
                            onfocus="this.select()" oninput="updateMISReceivedAuto();clearResults()" />
                    </div>
                    <div class="fg">
                        <label>Interest Already Received (‚Çπ)</label>
                        <input type="number" id="inp-received" placeholder="e.g. 5000" value="0" onfocus="this.select()"
                            oninput="clearResults()" />
                    </div>
                </div>


                <!-- result boxes -->
                <div class="section-label" style="margin-top:8px">Calculated Result</div>
                <div class="result-row" id="result-row">
                    <div class="result-box rb-days">
                        <div class="rb-label">Total Days</div>
                        <div class="rb-val days-c" id="res-days">‚Äî</div>
                    </div>
                    <div class="result-box rb-rate">
                        <div class="rb-label">Rate Applied</div>
                        <div class="rb-val rate-c" id="res-rate">‚Äî</div>
                    </div>
                    <div class="result-box rb-int">
                        <div class="rb-label" id="res-int-label">Interest Earned</div>
                        <div class="rb-val int-c" id="res-int">‚Äî</div>
                    </div>
                    <div class="result-box rb-total">
                        <div class="rb-label">Total Amount</div>
                        <div class="rb-val total-c" id="res-total">‚Äî</div>
                    </div>
                </div>

                <!-- action buttons -->
                <div class="btn-row">
                    <button class="btn-primary" onclick="calculate()">üìä Show Report</button>
                    <button class="btn-secondary"
                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none;"
                        onclick="exportToPDF()">üìÑ PDF Report</button>
                    <button class="btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                    <button class="btn-secondary" onclick="resetCalc()">‚Ü∫ Reset</button>
                </div>

                <!-- inline report -->
                <div class="report-area" id="report-area"></div>
            </div>
        </div>
    </div> <!-- /page-home -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    PAGE 2 ‚Äî RATE SETTINGS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-settings">
        <div class="settings-wrap">
            <div class="settings-head">
                <h2>‚öôÔ∏è Rate Settings</h2>
                <p>Edit interest rate slabs below. Calculations will use the rates active on the <b>FD Start Date</b>.
                </p>
            </div>

            <!-- Period Selection -->
            <div id="period-selector-wrap">
                <div class="period-tabs" id="period-tabs">
                    <!-- Dynamic -->
                </div>
                <div class="period-meta" id="period-meta" style="display:none">
                    <div class="fg">
                        <label>Effective From Date</label>
                        <input type="date" id="period-effective-date" onchange="updatePeriodDate()" />
                    </div>
                    <div class="fg" style="flex:0; min-width:auto">
                        <label>&nbsp;</label>
                        <button class="btn-secondary"
                            style="border-color:var(--rose); color:var(--rose); padding: 10px 16px"
                            onclick="deletePeriod()">üóëÔ∏è Delete Period</button>
                    </div>
                </div>
            </div>

            <!-- FD Rates -->
            <div class="rate-card">
                <div class="section-label">Fixed Deposit (FD) Rates</div>
                <div class="sub-tabs" id="fd-sub-tabs"
                    style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                    <button class="sub-tab active" onclick="switchFdSubTab('all', this)"
                        style="background:none; border:none; color:var(--text); font-weight:600; cursor:pointer; padding:5px 10px; border-radius:5px;">Regular
                        / All</button>
                    <button class="sub-tab" onclick="switchFdSubTab('sc', this)"
                        style="background:none; border:none; color:var(--text2); font-weight:600; cursor:pointer; padding:5px 10px; border-radius:5px;">Senior
                        Citizen Only</button>
                </div>
                <table class="rate-table" id="fd-rate-table">
                    <thead>
                        <tr>
                            <th>Duration</th>
                            <th>All (% p.a.)</th>
                            <th>Senior Citizen (% p.a.)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="fd-tbody"></tbody>
                </table>
            </div>

            <!-- MIS Rates -->
            <div class="rate-card">
                <div class="section-label">Monthly Income Scheme (MIS) Rates</div>
                <table class="rate-table">
                    <thead>
                        <tr>
                            <th>Duration</th>
                            <th>All (% p.a.)</th>
                            <th>Senior Citizen (% p.a.)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="mis-tbody"></tbody>
                </table>
            </div>

            <!-- DD Rates -->
            <div class="rate-card">
                <div class="section-label">Dam Duppat (DD) Rates</div>
                <table class="rate-table">
                    <thead>
                        <tr>
                            <th>Scheme / Duration</th>
                            <th>All (% p.a.)</th>
                            <th>Senior Citizen (% p.a.)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="other-tbody"></tbody>
                </table>
            </div>

            <!-- DC Rates -->
            <div class="rate-card">
                <div class="section-label">Daily Collection (DC) Rates</div>
                <table class="rate-table">
                    <thead>
                        <tr>
                            <th>Duration</th>
                            <th>Monthly Interest Bonus Rate (% p.a.)</th>
                            <th>Senior Citizen (% p.a.)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="dc-tbody"></tbody>
                </table>
            </div>

            <div class="btn-row" style="margin-top:24px; padding:0 4px; flex-wrap: wrap;">
                <button class="btn-primary" style="flex:1; min-width: 200px;" onclick="saveAllRates()">üíæ Save All Rates
                    Locally</button>
                <button class="btn-secondary" style="flex:0.6; border-color:var(--accent); color:var(--accent)"
                    onclick="generateShareLink()">üîó Copy Share Link</button>
                <button class="btn-secondary" style="flex:0.6; border-color:var(--accent); color:var(--accent)"
                    onclick="copyCodeForGithub()">üíª Copy Code for GitHub</button>
                <button class="btn-secondary" style="flex:0.6; border-color:var(--accent); color:var(--accent)"
                    onclick="exportSettings()">üì¶ Export rates_db.js File</button>
                <button class="btn-secondary" style="flex:0.6; border-color:var(--accent); color:var(--accent)"
                    onclick="refreshFromFile()">üîÑ Force Sync from File</button>
                <button class="btn-secondary" style="flex:0.6; border-color:var(--accent); color:var(--accent)"
                    onclick="triggerImport()">üì• Import JSON</button>
                <button class="btn-secondary" style="flex:0.4; border-color:var(--rose); color:var(--rose)"
                    onclick="resetRatesToDefault()">‚Ü∫ Reset Defaults</button>
            </div>
            <input type="file" id="import-file" style="display:none" onchange="importSettings(event)" accept=".json" />
        </div>
    </div> <!-- /page-settings -->

    <script src="rates_db.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  DEFAULT RATE SLABS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const DEFAULT_RATES = {
            fd: [
                { label: '30 ‚Äì 45 days', minD: 30, maxD: 45, all: 4.00, sc: 4.00 },
                { label: '46 ‚Äì 90 days', minD: 46, maxD: 90, all: 4.50, sc: 4.50 },
                { label: '91 ‚Äì 180 days', minD: 91, maxD: 180, all: 5.50, sc: 5.50 },
                { label: '181 ‚Äì 365 days', minD: 181, maxD: 365, all: 7.25, sc: 7.25 },
                { label: '13 ‚Äì 24 months', minD: 366, maxD: 730, all: 9.00, sc: 9.25 },
                { label: 'Above 25 months', minD: 731, maxD: 99999, all: 9.25, sc: 9.50 },
            ],
            mis: [
                { label: 'Above 12 months', minD: 366, maxD: 99999, all: 9.25, sc: 9.50 },
            ],
            dd: [
                { label: 'DD ‚Äî 90 Months', minD: 1, maxD: 99999, all: 9.50, sc: 9.50 },
            ],
            dc: [
                { label: 'DC ‚Äî 6 to 12 Months', minD: 180, maxD: 364, all: 2.50, sc: 2.50 },
                { label: 'DC ‚Äî 12 Months Plus', minD: 365, maxD: 99999, all: 5.00, sc: 5.00 },
            ],
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  LOAD / SAVE RATES (Multi-Period)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function saveRatesToStorage() {
            RATE_DATA.updatedAt = Date.now();
            localStorage.setItem('fd_planner_rates_v2', JSON.stringify(RATE_DATA));
        }

        function loadRates() {
            try {
                // 1. Check for URL Share Link (Highest Priority)
                const urlParams = new URLSearchParams(window.location.search);
                const sharedData = urlParams.get('rates');
                if (sharedData) {
                    try {
                        const decodedStr = decodeURIComponent(escape(atob(sharedData)));
                        const decoded = JSON.parse(decodedStr);
                        if (decoded && decoded.periods && Array.isArray(decoded.periods)) {
                            RATE_DATA = decoded;
                            saveRatesToStorage();
                            showToast('Rates loaded from Link!');
                            window.history.replaceState({}, document.title, window.location.pathname);
                            setActivePeriod(RATE_DATA.activePeriodId || (RATE_DATA.periods[0] ? RATE_DATA.periods[0].id : null));
                            return;
                        }
                    } catch (e) { console.error("URL Parse error", e); }
                }

                // 2. Load LocalStorage & File Data
                const localSaved = localStorage.getItem('fd_planner_rates_v2');
                const fileData = window.RATE_DATA_FILE;

                let localData = localSaved ? JSON.parse(localSaved) : null;

                // 3. Auto-Sync Logic (Comparison)
                if (localData && fileData) {
                    const localTime = localData.updatedAt || 0;
                    const fileTime = fileData.updatedAt || 0;

                    if (fileTime > localTime) {
                        // File is newer (Sync from OneDrive)
                        RATE_DATA = JSON.parse(JSON.stringify(fileData));
                        saveRatesToStorage();
                        showToast('üîÑ Auto-Synced from OneDrive!');
                    } else {
                        // Local is newer or same
                        RATE_DATA = localData;
                    }
                } else if (localData) {
                    RATE_DATA = localData;
                } else if (fileData) {
                    RATE_DATA = JSON.parse(JSON.stringify(fileData));
                } else {
                    // Fallback to Defaults
                    const v1 = localStorage.getItem('fd_planner_rates');
                    const initialRates = v1 ? JSON.parse(v1) : JSON.parse(JSON.stringify(DEFAULT_RATES));
                    const defaultPid = 'p_' + Date.now();
                    RATE_DATA = {
                        activePeriodId: defaultPid,
                        updatedAt: Date.now(),
                        periods: [{
                            id: defaultPid,
                            effectiveFrom: '1900-01-01',
                            name: 'Initial Rates',
                            rates: initialRates
                        }]
                    };
                    saveRatesToStorage();
                }

                setActivePeriod(RATE_DATA.activePeriodId || (RATE_DATA.periods[0] ? RATE_DATA.periods[0].id : 'p_initial'));
            } catch (e) {
                console.error("Load error", e);
                resetRatesToDefault(true);
            }
        }

        function refreshFromFile() {
            if (!window.RATE_DATA_FILE) {
                alert('No rates_db.js file found in the project folder.');
                return;
            }
            if (confirm('Check for updates in rates_db.js?')) {
                const localSaved = localStorage.getItem('fd_planner_rates_v2');
                let localData = localSaved ? JSON.parse(localSaved) : null;
                const fileData = window.RATE_DATA_FILE;

                const localTime = (localData && localData.updatedAt) ? localData.updatedAt : 0;
                const fileTime = fileData.updatedAt || 0;

                if (fileTime > localTime || !localData) {
                    RATE_DATA = JSON.parse(JSON.stringify(fileData));
                    saveRatesToStorage();
                    setActivePeriod(RATE_DATA.activePeriodId);
                    renderPeriodTabs();
                    buildRateTables();
                    showToast('üîÑ Synced from OneDrive!');
                } else {
                    alert('Your local settings are already up to date with rates_db.js.');
                }
            }
        }

        function setActivePeriod(id) {
            RATE_DATA.activePeriodId = id;
            const period = RATE_DATA.periods.find(p => p.id === id);
            if (period) {
                RATES = period.rates;
            }
        }

        function addNewPeriod() {
            const id = 'p_' + Date.now();
            const currentRates = JSON.parse(JSON.stringify(RATES));
            RATE_DATA.periods.push({
                id: id,
                effectiveFrom: todayStr(),
                name: 'New Period',
                rates: currentRates
            });
            RATE_DATA.periods.sort((a, b) => new Date(b.effectiveFrom) - new Date(a.effectiveFrom));
            RATE_DATA.activePeriodId = id;
            setActivePeriod(id);
            saveRatesToStorage();
            renderPeriodTabs();
            buildRateTables();
            showToast('New period added!');
        }

        function updatePeriodDate() {
            const dateV = document.getElementById('period-effective-date').value;
            const period = RATE_DATA.periods.find(p => p.id === RATE_DATA.activePeriodId);
            if (period && dateV) {
                period.effectiveFrom = dateV;
                RATE_DATA.periods.sort((a, b) => new Date(b.effectiveFrom) - new Date(a.effectiveFrom));
                saveRatesToStorage();
                renderPeriodTabs();
            }
        }

        function deletePeriod() {
            if (RATE_DATA.periods.length <= 1) {
                alert('Cannot delete the last remaining period.');
                return;
            }
            if (!confirm('Are you sure you want to delete this rate period?')) return;
            const idx = RATE_DATA.periods.findIndex(p => p.id === RATE_DATA.activePeriodId);
            RATE_DATA.periods.splice(idx, 1);
            RATE_DATA.activePeriodId = RATE_DATA.periods[0].id;
            setActivePeriod(RATE_DATA.activePeriodId);
            saveRatesToStorage();
            renderPeriodTabs();
            buildRateTables();
            showToast('Period deleted.');
        }

        function renderPeriodTabs() {
            const wrap = document.getElementById('period-tabs');
            if (!wrap) return;
            wrap.innerHTML = '';

            RATE_DATA.periods.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'period-tab' + (p.id === RATE_DATA.activePeriodId ? ' active' : '');
                btn.innerHTML = `
                    <span>Period</span>
                    <span class="period-date">${p.effectiveFrom === '1900-01-01' ? 'Static / Older' : p.effectiveFrom}</span>
                `;
                btn.onclick = () => {
                    setActivePeriod(p.id);
                    renderPeriodTabs();
                    buildRateTables();
                };
                wrap.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-period';
            addBtn.innerHTML = '+ Add Period';
            addBtn.onclick = addNewPeriod;
            wrap.appendChild(addBtn);

            const metaWrap = document.getElementById('period-meta');
            const activePeriod = RATE_DATA.periods.find(p => p.id === RATE_DATA.activePeriodId);
            if (activePeriod) {
                metaWrap.style.display = 'flex';
                document.getElementById('period-effective-date').value = activePeriod.effectiveFrom;
                document.getElementById('period-effective-date').disabled = (activePeriod.effectiveFrom === '1900-01-01');
            } else {
                metaWrap.style.display = 'none';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let currentTab = 'FD';
        let isSenior = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  PAGE NAV (with Password Protection)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showPage(name, btn) {
            // Check authorization for settings
            if (name === 'settings') {
                const pass = prompt("Enter Password to access Rate Settings:");
                if (pass === '1234') {
                    // Password correct, proceed
                } else {
                    if (pass !== null) alert("Incorrect Password!");
                    return; // Stay on current page
                }
            }

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-' + name).classList.add('active');
            btn.classList.add('active');

            if (name === 'settings') {
                renderPeriodTabs();
                buildRateTables();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  SCHEME TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const TAB_LABELS = {
            FD: 'Fixed Deposit ‚Äî Before Maturity Calculator',
            DD: 'Dam Duppat (Daily Deposit) ‚Äî Before Maturity Calculator',
            MIS: 'Monthly Income Scheme ‚Äî Before Maturity Calculator',
            DC: 'Daily Collection (Pigmy) ‚Äî Before Maturity Calculator',
        };

        function switchTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.scheme-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-label').textContent = TAB_LABELS[tab];

            document.getElementById('mis-extra').style.display = (tab === 'MIS') ? 'grid' : 'none';
            document.getElementById('slab-rate-fg').style.display = (tab === 'DC') ? 'none' : 'flex';

            updateRateFromSlab();
            clearResults();
        }

        function setSenior(val, btn) {
            isSenior = val;
            document.querySelectorAll('.senior-tab').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'transparent';
                b.style.color = 'var(--text2)';
            });
            btn.classList.add('active');
            btn.style.background = 'var(--accent)';
            btn.style.color = '#fff';
            updateRateFromSlab();
            clearResults();
        }

        function updateRateFromSlab() {
            const startV = document.getElementById('inp-start').value;
            const withdrawV = document.getElementById('inp-withdraw').value || todayStr();
            const tab = currentTab;
            if (!startV || tab === 'DC') return;

            const days = daysBetween(startV, withdrawV);
            if (days <= 0) return;

            // Premature Slab Rate
            const lookupTab = (tab === 'MIS' || tab === 'DD') ? 'FD' : tab;
            const rObj = getRate(lookupTab, days, startV);
            if (rObj) {
                document.getElementById('inp-slab-rate').value = rObj.rate;
            }

            // MIS Opening Rate
            if (tab === 'MIS') {
                const misRObj = getRate('MIS', days, startV);
                if (misRObj) {
                    document.getElementById('inp-opening-rate').value = misRObj.rate;
                }
            }

            updateMISReceivedAuto();
            clearResults();
        }

        function updateMISReceivedAuto() {
            if (currentTab !== 'MIS') return;
            const P = parseFloat(document.getElementById('inp-principal').value);
            const R = parseFloat(document.getElementById('inp-opening-rate').value);
            const startV = document.getElementById('inp-start').value;
            const withdrawV = document.getElementById('inp-withdraw').value || todayStr();

            if (isNaN(P) || isNaN(R) || !startV) return;

            const days = daysBetween(startV, withdrawV);
            if (days < 30) {
                document.getElementById('inp-received').value = "0";
                return;
            }

            const monthsCompleted = Math.floor(days / 30);
            const monthlyInt = Math.round((P * (R / 100)) / 12);
            document.getElementById('inp-received').value = (monthsCompleted * monthlyInt);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  DATE UTILS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function todayStr() {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }

        function daysBetween(s, e) {
            const ms = new Date(e) - new Date(s);
            return Math.round(ms / (1000 * 60 * 60 * 24));
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  RATE LOOKUP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function getRate(tab, days, startDate = null) {
            let currentRates = RATES;
            if (startDate) {
                const sorted = [...RATE_DATA.periods].sort((a, b) => new Date(b.effectiveFrom) - new Date(a.effectiveFrom));
                const period = sorted.find(p => p.effectiveFrom <= startDate) || sorted[sorted.length - 1];
                if (period) currentRates = period.rates;
            }

            const slabKey = tab.toLowerCase();
            if (!currentRates[slabKey]) return null;
            const slabs = currentRates[slabKey];

            for (const s of slabs) {
                if (days >= s.minD && days <= s.maxD) {
                    if (isSenior && s.sc != null) return { rate: s.sc, label: s.label };
                    return { rate: s.all, label: s.label };
                }
            }
            return null;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  FORMAT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function rupee(n) {
            const rounded = Math.round(n * 100) / 100;
            return '‚Çπ' + rounded.toLocaleString('en-IN', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            });
        }

        function nowStr() {
            return new Date().toLocaleDateString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  CALCULATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function calculate() {
            const P = parseFloat(document.getElementById('inp-principal').value);
            const startV = document.getElementById('inp-start').value;
            const withdrawV = document.getElementById('inp-withdraw').value || todayStr();
            const tab = currentTab;

            if (!P || P <= 0) {
                alert('Please enter a valid Deposit Amount.');
                return;
            }
            if (!startV) {
                alert('Please enter the Start Date.');
                return;
            }

            const days = daysBetween(startV, withdrawV);
            const months = days / 30.44;

            if (days <= 0) {
                alert('Withdrawal date must be after Start date.');
                return;
            }

            let baseRate = 0, appliedRate = 0, r = 0, rObj = null;
            const manualSlabRate = parseFloat(document.getElementById('inp-slab-rate').value);

            if (tab !== 'DC') {
                if (!isNaN(manualSlabRate) && manualSlabRate > 0) {
                    baseRate = manualSlabRate;
                } else {
                    // For MIS and DD, use FD slabs as premature rule
                    const lookupTab = (tab === 'MIS' || tab === 'DD') ? 'FD' : tab;
                    rObj = getRate(lookupTab, days, startV);
                    if (!rObj) {
                        alert('No rate slab found for ' + days + ' days under ' + lookupTab + '. Please check Rate Settings.');
                        return;
                    }
                    baseRate = rObj.rate;
                }
                appliedRate = Math.max(0, baseRate - 1);
                r = appliedRate / 100;
            }

            let interest = 0, total = 0, note = '';

            if (tab === 'FD') {
                interest = P * r * (days / 365);
                total = P + interest;
                note = 'Simple Interest';
            } else if (tab === 'MIS') {
                const received = parseFloat(document.getElementById('inp-received').value) || 0;
                interest = Math.round(P * r * (days / 365));
                total = P + interest - received;
                note = 'Rounded Simple Interest (Less already paid)';
            } else if (tab === 'DD') {
                interest = P * r * (days / 365);
                total = P + interest;
                note = 'Simple Interest (Premature FD Slab -1%)';
            } else if (tab === 'DC') {
                if (days < 30) {
                    interest = 0; total = P; note = 'No Interest (< 30 days)';
                } else if (days >= 30 && days < 90) {
                    const monthsCompleted = Math.floor(days / 30);
                    const threshold = monthsCompleted * 9000;
                    if (P >= threshold) {
                        interest = 0; total = P; note = `Full Payment (‚â• ‚Çπ${threshold} for ${monthsCompleted} mo)`;
                    } else {
                        const comm = P * 0.025; interest = -comm; total = P - comm; note = `2.5% Commission Deduction (< ‚Çπ${threshold})`;
                    }
                } else if (days >= 90 && days < 180) {
                    interest = 0; total = P; note = 'Full Payment (No cutting after 90 days)';
                } else if (days >= 180 && days < 365) {
                    const rDC = isSenior ? RATES.dc[0].sc : RATES.dc[0].all;
                    interest = Math.floor(P * (rDC / 100) / 12);
                    total = P + interest;
                    note = `Bonus: 1 Month @ ${rDC.toFixed(2)}% p.a. (Senior: ${isSenior})`;
                } else {
                    const rDC = isSenior ? RATES.dc[1].sc : RATES.dc[1].all;
                    interest = Math.floor(P * (rDC / 100) / 12);
                    total = P + interest;
                    note = `Bonus: 1 Month @ ${rDC.toFixed(2)}% p.a. (Senior: ${isSenior})`;
                }
            }

            document.getElementById('res-days').textContent = days + ' days (' + (months).toFixed(1) + ' mo)';
            if (tab === 'DC') {
                document.getElementById('res-rate').textContent = (interest > 0 ? (interest / P * 100).toFixed(1) + '%' : (interest < 0 ? '-2.5%' : '0%'));
            } else {
                document.getElementById('res-rate').innerHTML = `<span style="text-decoration:line-through; font-size:0.75rem; opacity:0.6">${baseRate.toFixed(2)}%</span> ${appliedRate.toFixed(2)}% p.a.`;
            }

            document.getElementById('res-int-label').textContent = interest >= 0 ? 'Interest / Bonus' : 'Commission';
            document.getElementById('res-int').textContent = interest >= 0 ? rupee(interest) : `‚àí${rupee(Math.abs(interest))}`;
            document.getElementById('res-int').style.color = interest >= 0 ? 'var(--green)' : 'var(--red)';
            document.getElementById('res-total').textContent = rupee(total);

            const comm = (tab === 'RD') ? (parseFloat(document.getElementById('inp-commission').value) || 0) : 0;
            const installVal = (tab === 'RD') ? (parseFloat(document.getElementById('inp-install').value) || P) : null;
            const startFmt = new Date(startV).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
            const withdrawFmt = new Date(withdrawV).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

            const rptHtml = `
                <div class="report-card" id="report-printable">
                    <div class="report-head">
                        <div class="report-title">üìÑ ${tab} ‚Äî Maturity Report 
                            <span style="font-size:.75rem;font-weight:400;color:var(--text2)">${(tab === 'DC' || !rObj) ? '' : `(${rObj.label})`}</span>
                        </div>
                        <div class="report-date">Generated: ${nowStr()}</div>
                    </div>
                    <table class="report-table">
                        <tr><td>Scheme</td><td>${tab} ‚Äî ${TAB_LABELS[tab].split('‚Äî')[0].trim()}</td></tr>
                        <tr><td>Account Type</td><td>${isSenior ? 'Senior Citizen' : 'Regular'}</td></tr>
                        <tr><td>Deposit Amount</td><td class="hi">${rupee(P)}</td></tr>
                        <tr><td>Start Date</td><td>${startFmt}</td></tr>
                        <tr><td>Withdrawal Date</td><td>${withdrawFmt}</td></tr>
                        <tr><td>Total Duration</td><td>${days} days (${months.toFixed(1)} months)</td></tr>
                        ${tab === 'DC' ? `<tr><td>Applied Slab Rule</td><td class="hi">${note}</td></tr>` : `
                        <tr><td>Slab Base Rate</td><td>${baseRate.toFixed(2)}% p.a.</td></tr>
                        <tr><td>Penalty Applied</td><td style="color:var(--red)">‚àí1.00% (Premature Withdrawal)</td></tr>
                        <tr><td>Effective Rate</td><td class="hi">${appliedRate.toFixed(2)}% p.a. (${note})</td></tr>`}
                        <tr><td>${interest >= 0 ? (tab === 'MIS' ? 'Total Interest Earned' : 'Interest / Bonus') : 'Commission Deducted'}</td>
                        <td class="${interest >= 0 ? 'gr' : 'hi'}" style="${interest < 0 ? 'color:var(--red)' : ''}">${interest >= 0 ? rupee(interest) : `‚àí${rupee(Math.abs(interest))}`}</td></tr>
                        ${(tab === 'MIS') ? `<tr><td>Interest Already Received</td><td style="color:var(--red)">‚àí${rupee(parseFloat(document.getElementById('inp-received').value) || 0)}</td></tr>
                        ${(parseFloat(document.getElementById('inp-received').value) > interest) ? `<tr style="border-top:1px dashed var(--border)"><td><strong>Recovery / Difference Amount</strong></td><td style="color:var(--red)"><strong>‚àí${rupee(parseFloat(document.getElementById('inp-received').value) - interest)}</strong></td></tr>` : ''}` : ''}
                        <tr class="total-row"><td>Total Amount Payable</td><td>${rupee(total)}</td></tr>
                        ${(tab === 'MIS' && total < P) ? `<tr><td colspan="2" style="font-size:0.75rem; color:var(--red); text-align:right;">‚ö†Ô∏è Difference amount recovered from Principal.</td></tr>` : ''}
                    </table>
                    <div class="print-note">This is a computer-generated estimate. Actual amount may vary based on bank policy.</div>
                </div>`;
            document.getElementById('report-area').innerHTML = rptHtml;
            document.getElementById('report-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearResults() {
            ['res-days', 'res-rate', 'res-int', 'res-total'].forEach(id => document.getElementById(id).textContent = '‚Äî');
            document.getElementById('report-area').innerHTML = '';
        }

        function resetCalc() {
            ['inp-principal', 'inp-start', 'inp-withdraw', 'inp-slab-rate', 'inp-opening-rate'].forEach(id => document.getElementById(id).value = '');
            ['inp-received'].forEach(id => document.getElementById(id).value = '0');
            isSenior = false;
            document.querySelectorAll('.senior-opt').forEach((b, i) => b.classList.toggle('active', i === 0));
            clearResults();
        }

        function printReport() {
            if (!document.getElementById('report-printable')) {
                calculate();
                setTimeout(() => window.print(), 200);
            } else {
                window.print();
            }
        }

        function exportToPDF() {
            const table = document.querySelector('.report-table');
            if (!table) {
                calculate();
                setTimeout(() => {
                    const tableAfter = document.querySelector('.report-table');
                    if (tableAfter) {
                        generatePDF();
                    } else {
                        alert('Could not automatically generate report. Please click "Show Report" first, then click "PDF Report".');
                    }
                }, 400);
            } else {
                generatePDF();
            }
        }

        function generatePDF() {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('ERROR: PDF library (jsPDF) is NOT loaded. Please check your internet connection and refresh the page.');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const table = document.querySelector('.report-table');
                if (!table) {
                    alert('No report data found. Please enter details and show report first.');
                    return;
                }

                // Header
                doc.setFontSize(18);
                doc.setTextColor(108, 99, 255); // var(--accent)
                doc.text(`${currentTab} Maturity Report`, 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${nowStr()}`, 195, 20, { align: 'right' });

                // Manually extract data from the HTML table
                const rows = [];
                const tableRows = Array.from(table.rows);
                let maxCols = 0;

                tableRows.forEach(tr => {
                    const cells = Array.from(tr.cells);
                    maxCols = Math.max(maxCols, cells.length);

                    if (cells.length === 1) {
                        // Span/Warning row
                        rows.push([{
                            content: cells[0].innerText.replace('‚Çπ', 'Rs. '),
                            colSpan: 2,
                            styles: { halign: 'center', fontStyle: 'italic', textColor: [225, 29, 72] }
                        }]);
                    } else {
                        const rowData = cells.map(c => c.innerText.replace('‚Çπ', 'Rs. '));
                        rows.push(rowData);
                    }
                });

                const head = maxCols === 3 ? [['Field', 'Value', 'Recovery']] : [['Field', 'Value']];

                doc.autoTable({
                    head: head,
                    body: rows,
                    startY: 30,
                    theme: 'grid',
                    styles: {
                        overflow: 'linebreak',
                        cellPadding: 3,
                        fontSize: 8,
                        font: 'helvetica'
                    },
                    headStyles: { fillColor: [108, 99, 255], textColor: 255 },
                    columnStyles: {
                        0: { cellWidth: 45, fontStyle: 'bold' },
                        1: { cellWidth: maxCols === 3 ? 65 : 135, halign: 'right' },
                        2: { cellWidth: 70, halign: 'right' }
                    },
                    tableWidth: 180, // Total fixed width (A4 is ~210mm, margins 15mm each)
                    margin: { left: 15, right: 15 },
                    didParseCell: function (data) {
                        // Bold amounts
                        if (data.cell.text && data.cell.text[0] && data.cell.text[0].includes('Rs.')) {
                            data.cell.styles.fontStyle = 'bold';
                        }

                        // Highlight Total Row
                        const firstCellText = (data.row.cells[0] && data.row.cells[0].text[0]) || '';
                        if (firstCellText.includes('Total Amount Payable')) {
                            Object.values(data.row.cells).forEach(cell => {
                                cell.styles.fillColor = [245, 158, 11]; // gold
                                cell.styles.textColor = 0;
                                cell.styles.fontStyle = 'bold';
                            });
                        }
                    }
                });

                const fileName = `${currentTab}_Report_${new Date().getTime()}.pdf`;
                doc.save(fileName);
            } catch (err) {
                console.error('PDF Generation Error:', err);
                alert('An error occurred while generating the PDF: ' + err.message);
            }
        }

        let activeFdSubTab = 'all';
        function switchFdSubTab(tab, btn) {
            activeFdSubTab = tab;
            document.querySelectorAll('#fd-sub-tabs .sub-tab').forEach(b => {
                b.classList.remove('active');
                b.style.color = 'var(--text2)';
                b.style.background = 'none';
            });
            btn.classList.add('active');
            btn.style.color = 'var(--text)';
            btn.style.background = 'rgba(108, 99, 255, 0.1)';
            buildRateTables();
        }

        function buildRateTables() {
            buildTable('fd-tbody', RATES.fd, 'fd');
            buildTable('mis-tbody', RATES.mis, 'mis');
            buildTable('dc-tbody', RATES.dc, 'dc');
            buildTable('other-tbody', RATES.dd, 'dd');
        }

        function resetRatesToDefault(auto = false) {
            if (!auto && !confirm('Are you sure? This will overwrite ALL periods.')) return;
            const defaultPid = 'p_default';
            RATE_DATA = { activePeriodId: defaultPid, periods: [{ id: defaultPid, effectiveFrom: '1900-01-01', name: 'System Defaults', rates: JSON.parse(JSON.stringify(DEFAULT_RATES)) }] };
            setActivePeriod(defaultPid);
            saveRatesToStorage();
            if (!auto) { renderPeriodTabs(); buildRateTables(); showToast('Rates reset!'); }
        }

        function buildTable(tbodyId, slabs, key) {
            const tbody = document.getElementById(tbodyId); tbody.innerHTML = '';

            // Re-render header if it's FD to show/hide columns
            if (key === 'fd') {
                const thead = tbody.closest('table').querySelector('thead tr');
                if (activeFdSubTab === 'all') {
                    thead.innerHTML = `<th>Duration</th><th>All (% p.a.)</th><th>Senior Citizen (% p.a.)</th><th>Action</th>`;
                } else {
                    thead.innerHTML = `<th>Duration</th><th>Senior Citizen (% p.a.)</th><th>Action</th>`;
                }
            }

            slabs.forEach((s, i) => {
                const tr = document.createElement('tr');
                let cols = '';
                const scVal = (s.sc !== undefined && s.sc !== null) ? s.sc : s.all;

                if (key === 'fd' && activeFdSubTab === 'sc') {
                    cols = `<td><input class="rate-input" type="number" step="0.01" value="${scVal}" id="rt-${key}-sc-${i}" onfocus="this.select()" /></td>`;
                } else {
                    cols = `<td><input class="rate-input" type="number" step="0.01" value="${s.all}" id="rt-${key}-all-${i}" onfocus="this.select()" /></td>
                            <td><input class="rate-input" type="number" step="0.01" value="${scVal}" id="rt-${key}-sc-${i}" onfocus="this.select()" /></td>`;
                }

                tr.innerHTML = `
                    <td class="td-dur">
                        <input class="rate-input label-inp" type="text" value="${s.label}" id="rt-${key}-label-${i}" onfocus="this.select()" title="Slab Label" />
                        <div class="day-range">
                            <input class="rate-input day-inp" type="number" value="${s.minD}" id="rt-${key}-minD-${i}" onfocus="this.select()" title="Min Days" />
                            <span>‚Äì</span>
                            <input class="rate-input day-inp" type="number" value="${s.maxD}" id="rt-${key}-maxD-${i}" onfocus="this.select()" title="Max Days" />
                        </div>
                    </td>
                    ${cols}
                    <td>
                        <div style="display:flex; gap:4px">
                            <button class="btn-update" onclick="updateRow('${key}',${i},this)">Update</button>
                            ${(slabs.length > 1) ? `<button class="btn-update" style="background:var(--rose); color:#fff; border:none" onclick="removeSlab('${key}',${i})">√ó</button>` : ''}
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
            // Add Row
            const addTr = document.createElement('tr');
            const colSpan = (key === 'fd' && activeFdSubTab === 'sc') ? 3 : 4;
            addTr.innerHTML = `<td colspan="${colSpan}" style="text-align:center"><button class="btn-add-period" style="margin:4px 0; width:100%" onclick="addSlab('${key}')">+ Add New Slab</button></td>`;
            tbody.appendChild(addTr);
        }


        function addSlab(key) {
            const slabs = RATES[key];
            const last = slabs[slabs.length - 1];
            slabs.push({
                label: 'New Slab',
                minD: last ? last.maxD + 1 : 1,
                maxD: last ? last.maxD + 30 : 30,
                all: last ? last.all : 5.00,
                sc: last ? last.sc : 5.50
            });
            saveRatesToStorage();
            buildRateTables();
            showToast('New slab added!');
        }

        function removeSlab(key, idx) {
            if (!confirm('Remove this rate slab?')) return;
            RATES[key].splice(idx, 1);
            saveRatesToStorage();
            buildRateTables();
            showToast('Slab removed.');
        }

        function updateRow(key, idx, btn) {
            const labelEl = document.getElementById(`rt-${key}-label-${idx}`);
            const minDEl = document.getElementById(`rt-${key}-minD-${idx}`);
            const maxDEl = document.getElementById(`rt-${key}-maxD-${idx}`);
            const allEl = document.getElementById(`rt-${key}-all-${idx}`);
            const scEl = document.getElementById(`rt-${key}-sc-${idx}`);

            if (labelEl) RATES[key][idx].label = labelEl.value;
            if (minDEl) RATES[key][idx].minD = parseInt(minDEl.value) || 0;
            if (maxDEl) RATES[key][idx].maxD = parseInt(maxDEl.value) || 0;
            if (allEl) RATES[key][idx].all = parseFloat(allEl.value) || 0;
            if (scEl && scEl.value !== undefined) RATES[key][idx].sc = parseFloat(scEl.value) || 0;

            saveRatesToStorage();
            btn.textContent = '‚úì Saved'; btn.classList.add('saved');
            setTimeout(() => { btn.textContent = 'Update'; btn.classList.remove('saved') }, 1800);
            showToast('Rate updated!');
        }

        function saveAllRates() {
            ['fd', 'mis', 'dd', 'dc'].forEach(key => {
                RATES[key].forEach((s, i) => {
                    const labelEl = document.getElementById(`rt-${key}-label-${i}`);
                    const minDEl = document.getElementById(`rt-${key}-minD-${i}`);
                    const maxDEl = document.getElementById(`rt-${key}-maxD-${i}`);
                    const allEl = document.getElementById(`rt-${key}-all-${i}`);
                    const scEl = document.getElementById(`rt-${key}-sc-${i}`);

                    if (labelEl) s.label = labelEl.value;
                    if (minDEl) s.minD = parseInt(minDEl.value) || 0;
                    if (maxDEl) s.maxD = parseInt(maxDEl.value) || 0;
                    if (allEl) s.all = parseFloat(allEl.value) || 0;
                    if (scEl && s.sc != null) s.sc = parseFloat(scEl.value) || 0;
                });
            });
            saveRatesToStorage(); showToast('All rates saved!');
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2200);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  SHARE LINK / EXPORT / IMPORT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function generateShareLink() {
            try {
                const json = JSON.stringify(RATE_DATA);
                const base64 = btoa(unescape(encodeURIComponent(json)));
                const shareUrl = window.location.origin + window.location.pathname + '?rates=' + base64;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert('Share link copied to clipboard!\n\nSend this link to another computer to instantly load these rates.');
                        showToast('Link Copied!');
                    }).catch(err => {
                        console.error('Clipboard error', err);
                        fallbackCopy(shareUrl);
                    });
                } else {
                    fallbackCopy(shareUrl);
                }
            } catch (e) {
                console.error("Share error", e);
                alert("Could not generate share link. The data might be too large.");
            }
        }

        function fallbackCopy(text) {
            const input = document.createElement('textarea');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            try {
                document.execCommand('copy');
                alert('Share link copied (fallback method)!\n\nSend this link to another computer to instantly load these rates.');
                showToast('Link Copied!');
            } catch (err) {
                prompt('Could not auto-copy. Please copy this link manually:', text);
            }
            document.body.removeChild(input);
        }

        function exportSettings() {
            try {
                const content = `// Auto-generated Rate Database\nwindow.RATE_DATA_FILE = ${JSON.stringify(RATE_DATA, null, 2)};`;
                const blob = new Blob([content], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", url);
                downloadAnchorNode.setAttribute("download", "rates_db.js");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showToast('Exported rates_db.js!');

                alert('Success!\n1. The file "rates_db.js" is in your downloads.\n2. Move it to your project folder.\n3. OneDrive or GitHub will sync it to all devices.');
            } catch (err) {
                console.error('Export error', err);
                alert('Could not export settings.');
            }
        }

        function copyCodeForGithub() {
            try {
                const content = `// Auto-generated Rate Database\nwindow.RATE_DATA_FILE = ${JSON.stringify(RATE_DATA, null, 2)};`;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(() => {
                        alert('Code Copied!\n\nTo Sync on GitHub:\n1. Open your GitHub repo\n2. Open "rates_db.js"\n3. Click "Edit" (pencil icon)\n4. Select all and paste this code\n5. Click "Commit Changes"');
                        showToast('Code Copied!');
                    });
                } else {
                    fallbackCopy(content);
                }
            } catch (e) {
                console.error("Copy error", e);
                alert("Could not copy code.");
            }
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && importedData.periods && Array.isArray(importedData.periods)) {
                        if (confirm('Importing will overwrite your current settings for ALL periods. This cannot be undone. Continue?')) {
                            RATE_DATA = importedData;
                            saveRatesToStorage();
                            setActivePeriod(RATE_DATA.activePeriodId || RATE_DATA.periods[0].id);
                            renderPeriodTabs();
                            buildRateTables();
                            showToast('Settings imported successfully!');
                        }
                    } else {
                        alert('Invalid settings file format.');
                    }
                } catch (err) {
                    console.error('Import error', err);
                    alert('Error parsing settings file. Please ensure it is a valid .json file.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for next time
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('fd_planner_theme') || 'dark';
            if (savedTheme === 'light') { document.documentElement.classList.add('light-mode'); updateThemeUI(true); }
        }

        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light-mode');
            localStorage.setItem('fd_planner_theme', isLight ? 'light' : 'dark');
            updateThemeUI(isLight);
        }

        function updateThemeUI(isLight) {
            const icon = document.getElementById('theme-icon'); if (icon) icon.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        initTheme();
        // Load rates_db.js after it's included in the head
        loadRates();
        document.getElementById('inp-withdraw').value = todayStr();
    </script>
</body>

</html>